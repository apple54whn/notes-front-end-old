---
title: Vuex
date: 2022-02-08 22:57:49
permalink: /pages/fa4384/
categories:
  - x
  - Vuex
tags:
  - 
---

# Vuex

## Vuexçš„çŠ¶æ€ç®¡ç†

ç®¡ç†ä¸æ–­å˜åŒ–çš„stateæœ¬èº«æ˜¯éå¸¸å›°éš¾çš„:

* çŠ¶æ€ä¹‹é—´ç›¸äº’ä¼šå­˜åœ¨ä¾èµ–ï¼Œä¸€ä¸ªçŠ¶æ€çš„å˜åŒ–ä¼šå¼•èµ·å¦ä¸€ä¸ªçŠ¶æ€çš„å˜åŒ–ï¼ŒViewé¡µé¢ä¹Ÿæœ‰å¯èƒ½ä¼šå¼•èµ·çŠ¶æ€çš„å˜åŒ–;

* å½“åº”ç”¨ç¨‹åºå¤æ‚æ—¶ï¼Œstateåœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå› ä¸ºä»€ä¹ˆåŸå› è€Œå‘ç”Ÿäº†å˜åŒ–ï¼Œå‘ç”Ÿäº†æ€ä¹ˆæ ·çš„å˜åŒ–ï¼Œä¼šå˜å¾—éå¸¸éš¾ä»¥æ§åˆ¶å’Œè¿½è¸ª;

å› æ­¤ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥è€ƒè™‘**å°†ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€æŠ½ç¦»å‡ºæ¥**ï¼Œä»¥ä¸€ä¸ª**å…¨å±€å•ä¾‹**çš„æ–¹å¼æ¥ç®¡ç†å‘¢?

* åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çš„ç»„ä»¶æ ‘æ„æˆäº†ä¸€ä¸ªå·¨å¤§çš„ â€œè§†å›¾Viewâ€;

* ä¸ç®¡åœ¨æ ‘çš„å“ªä¸ªä½ç½®ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½**è·å–çŠ¶æ€**æˆ–è€…**è§¦å‘è¡Œä¸º**;

* é€šè¿‡å®šä¹‰å’Œéš”ç¦»çŠ¶æ€ç®¡ç†ä¸­çš„å„ä¸ªæ¦‚å¿µï¼Œå¹¶é€šè¿‡å¼ºåˆ¶æ€§çš„è§„åˆ™æ¥ç»´æŠ¤**è§†å›¾å’ŒçŠ¶æ€é—´çš„ç‹¬ç«‹æ€§**ï¼Œæˆ‘ä»¬çš„ä»£ç è¾¹ä¼šå˜å¾—æ›´åŠ ç»“æ„åŒ–å’Œæ˜“äºç»´æŠ¤ã€è·Ÿè¸ª;

è¿™å°±æ˜¯VuexèƒŒåçš„åŸºæœ¬æ€æƒ³ï¼Œå®ƒå€Ÿé‰´äº†Fluxã€Reduxã€Elmï¼ˆçº¯å‡½æ•°è¯­è¨€ï¼Œreduxæœ‰å€Ÿé‰´å®ƒçš„æ€æƒ³ï¼‰

æ¯ä¸€ä¸ªVuexåº”ç”¨çš„æ ¸å¿ƒå°±æ˜¯store(ä»“åº“)ï¼šstoreæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒåŒ…å«ç€ä½ çš„åº”ç”¨ä¸­å¤§éƒ¨åˆ†çš„çŠ¶æ€(state)

![image-20220208230011299](./images/image-20220208230011299.png)

**Vuexå’Œå•çº¯çš„å…¨å±€å¯¹è±¡æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢**ï¼Ÿ

* Vuexçš„çŠ¶æ€å­˜å‚¨æ˜¯**å“åº”å¼**çš„ã€‚å½“Vueç»„ä»¶ä»storeä¸­è¯»å–çŠ¶æ€çš„æ—¶å€™ï¼Œè‹¥storeä¸­çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç›¸åº”çš„ç»„ä»¶ä¹Ÿä¼šè¢«æ›´æ–°
* ä½ **ä¸èƒ½ç›´æ¥æ”¹å˜storeä¸­çš„çŠ¶æ€**ã€‚
  * æ”¹å˜storeä¸­çš„çŠ¶æ€çš„å”¯ä¸€é€”å¾„å°±æ˜¾ç¤º**æäº¤ (commit) mutation**;
  * è¿™æ ·ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„**è·Ÿè¸ªæ¯ä¸€ä¸ªçŠ¶æ€çš„å˜åŒ–**ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ä¸€äº›å·¥å…·å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç®¡ç†åº”ç”¨çš„çŠ¶æ€



## å®‰è£…

è¿™é‡Œä½¿ç”¨çš„æ˜¯vuex4.xï¼Œå®‰è£…çš„æ—¶å€™éœ€è¦æ·»åŠ  next æŒ‡å®šç‰ˆæœ¬ï¼ˆå®é™…æ ¹æ®å½“å‰ç‰ˆæœ¬å†³å®šæ·»åŠ nextä¸å¦ï¼‰

```bash
 npm install vuex@next
```

å®‰è£… Vue DevTools æµè§ˆå™¨æ’ä»¶ ğŸ”¥







## å•ä¸€çŠ¶æ€æ ‘ ğŸ”¥

Vuex ä½¿ç”¨**å•ä¸€çŠ¶æ€æ ‘**:

* ç”¨**ä¸€ä¸ªå¯¹è±¡å°±åŒ…å«äº†å…¨éƒ¨**çš„åº”ç”¨å±‚çº§çŠ¶ï¼ˆ**storeåªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯å¯ä»¥åˆ†æ¨¡å—**ï¼‰
* é‡‡ç”¨çš„æ˜¯SSOTï¼ŒSingle Source of Truthï¼Œä¹Ÿå¯ä»¥ç¿»è¯‘æˆå•ä¸€æ•°æ®æº; 
* è¿™ä¹Ÿæ„å‘³ç€ï¼Œæ¯ä¸ªåº”ç”¨å°†ä»…ä»…åŒ…å«ä¸€ä¸ª store å®ä¾‹;
* å•çŠ¶æ€æ ‘å’Œæ¨¡å—åŒ–å¹¶ä¸å†²çªï¼Œåé¢æˆ‘ä»¬ä¼šè®²åˆ°moduleçš„æ¦‚å¿µ;

å•ä¸€çŠ¶æ€æ ‘çš„ä¼˜åŠ¿:

* å¦‚æœä½ çš„çŠ¶æ€ä¿¡æ¯æ˜¯ä¿å­˜åˆ°å¤šä¸ªStoreå¯¹è±¡ä¸­çš„ï¼Œé‚£ä¹ˆä¹‹åçš„ç®¡ç†å’Œç»´æŠ¤ç­‰ç­‰éƒ½ä¼šå˜å¾—ç‰¹åˆ«å›°éš¾; 
* æ‰€ä»¥Vuexä¹Ÿä½¿ç”¨äº†å•ä¸€çŠ¶æ€æ ‘æ¥ç®¡ç†åº”ç”¨å±‚çº§çš„å…¨éƒ¨çŠ¶æ€;
* å•ä¸€çŠ¶æ€æ ‘èƒ½å¤Ÿè®©æˆ‘ä»¬æœ€ç›´æ¥çš„æ–¹å¼æ‰¾åˆ°æŸä¸ªçŠ¶æ€çš„ç‰‡æ®µï¼Œè€Œä¸”åœ¨ä¹‹åçš„ç»´æŠ¤å’Œè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿çš„ç®¡ç†å’Œç»´æŠ¤;



## åˆ›å»º store ğŸ”¥

ä½¿ç”¨æ­¥éª¤:

* åˆ›å»ºStoreå¯¹è±¡ï¼Œ/src/store/index.js

  ```js
  import { createStore } from 'vuex'
  
  export default createStore({
    state: {
    },
    mutations: {
    },
    actions: {
    },
    modules: {
    }
  })
  
  ```

* åœ¨appä¸­é€šè¿‡æ’ä»¶å®‰è£…ï¼Œ/src/main.js

  ```js
  import { createApp } from 'vue'
  import App from './App.vue'
  import store from './store'
  
  createApp(App).use(store).mount('#app')
  ```

åœ¨ç»„ä»¶ä¸­ä½¿ç”¨storeï¼Œæˆ‘ä»¬æŒ‰ç…§å¦‚ä¸‹çš„æ–¹å¼: 

* åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨;
* åœ¨options apiä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚computed; 
* åœ¨setupä¸­ä½¿ç”¨;





## state & mapState ğŸ”¥

/src/store/index.js

```js
import { createStore } from 'vuex'

export default createStore({
  state: {
    counter: 100,
    name: 'conanan',
    age: 18,
    height: 188,
  },
  mutations: {},
  actions: {},
  modules: {},
})
```



### options ä¸­ä½¿ç”¨

```vue
<template>
  <div>
    <h2>Home:{{ $store.state.counter }}</h2>
    <h2>Home:{{ sCounter }}</h2>
    <h2>Home:{{ sName }}</h2>
    <!-- <h2>Home:{{ age }}</h2>
    <h2>Home:{{ height }}</h2> -->
  </div>
</template>

<script>
import { mapState } from 'vuex'

export default {
  computed: {
    fullName() {
      return 'Kobe Bryant'
    },
    // å…¶ä»–çš„è®¡ç®—å±æ€§, ä»stateè·å–
    // 1 æ•°ç»„
    // ...mapState(["counter", "name", "age", "height"])
    // 2 å¯¹è±¡ï¼Œå¯èµ·åˆ«å
    ...mapState({
      sCounter: (state) => state.counter,
      sName: (state) => state.name,
    }),
  },
}
</script>
```



### composition ä¸­ä½¿ç”¨ ğŸ”¥

```vue
<template>
  <div>
    <h2>Home:{{ $store.state.counter }}</h2>
    <hr>
    <h2>{{sCounter}}</h2>
    <h2>{{counter}}</h2>
    <h2>{{name}}</h2>
    <h2>{{age}}</h2>
    <h2>{{height}}</h2>
    <hr>
  </div>
</template>

<script>
  import { mapState, useStore } from 'vuex'
  import { computed } from 'vue'

  export default {
    computed: {
      fullName: function() {
        return "1fdasfdasfad"
      },
      ...mapState(["name", "age"])
    },

    setup() {
      const store = useStore()
      const sCounter = computed(() => store.state.counter)
      // const sName = computed(() => store.state.name)
      // const sAge = computed(() => store.state.age)

      const storeStateFns = mapState(["counter", "name", "age", "height"])

      // {name: function, age: function, height: function}
      // {name: ref, age: ref, height: ref}
      const storeState = {}
      Object.keys(storeStateFns).forEach(fnKey => {
        const fn = storeStateFns[fnKey].bind({$store: store})
        storeState[fnKey] = computed(fn)
      })

      return {
        sCounter,
        ...storeState
      }
    }
  }
</script>
```

mapStateè¿”å›çš„æ˜¯å€¼ä¸ºfunctionçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è§£æ„ï¼Œéœ€éå†å¹¶ä½¿ç”¨è®¡ç®—å±æ€§ï¼Œå°è£…åè§ **Vuexå°è£…â€”æœ€ç»ˆ**

ä½¿ç”¨

```vue
<template>
  <div>
    <h2>Home:{{ $store.state.counter }}</h2>
    <hr />
    <h2>{{ counter }}</h2>
    <h2>{{ name }}</h2>
    <h2>{{ age }}</h2>
    <h2>{{ height }}</h2>
    <h2>{{ sCounter }}</h2>
    <h2>{{ sName }}</h2>
    <hr />
  </div>
</template>

<script>
// import { useState } from '../hooks/useVuex'

// export default {
//   setup() {
//     const storeState = useState(['counter', 'name', 'age', 'height'])
//     const storeState2 = useState({
//       sCounter: (state) => state.counter,
//       sName: (state) => state.name,
//     })

//     return {
//       ...storeState,
//       ...storeState2,
//     }
//   },
// }
//
</script>

<script setup>
import { useState } from '../hooks/useVuex'

const { counter, name, age, height } = useState([
  'counter',
  'name',
  'age',
  'height',
])
const { sCounter, sName } = useState({
  sCounter: (state) => state.counter,
  sName: (state) => state.name,
})
</script>
```



## getters & mapGetters å°è£… ğŸ”¥

æŸäº›å±æ€§æˆ‘ä»¬å¯èƒ½éœ€è¦**ç»è¿‡å˜åŒ–ï¼ˆè¿ç®—ï¼‰å**æ¥ä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨getters

/src/store/index.jsï¼Œè¦å±•ç¤ºå¦‚ä¸‹booksçš„æ€»ä»·æ ¼ç­‰ç­‰

```js
import { createStore } from 'vuex'

export default createStore({
  state: {
    counter: 100,
    name: 'conanan',
    age: 18,
    height: 188,
    books: [
      { name: 'æ·±å…¥Vuejs', price: 200, count: 3 },
      { name: 'æ·±å…¥Webpack', price: 240, count: 5 },
      { name: 'æ·±å…¥React', price: 130, count: 1 },
      { name: 'æ·±å…¥Node', price: 220, count: 2 },
    ],
  },
  mutations: {},
  actions: {},
  modules: {},
  getters: {
    // è°ƒç”¨å…¶ä»– getter
    totalPrice(state, getters) {
      let totalPrice = 0
      for (const book of state.books) {
        totalPrice += book.count * book.price
      }
      return totalPrice * getters.currentDiscount
    },
    currentDiscount(state) {
      return state.discount * 0.9
    },
    // ä¼ é€’å‚æ•°
    totalPriceCountGreaterN(state, getters) {
      return function (n) {
        let totalPrice = 0
        for (const book of state.books) {
          if (book.count > n) {
            totalPrice += book.count * book.price
          }
        }
        return totalPrice * getters.currentDiscount
      }
    },
  },
})
```



### options ä¸­ä½¿ç”¨

```vue
<template>
  <div>
    <h2>æ€»ä»·å€¼: {{ $store.getters.totalPrice }}</h2>
    <h2>æ€»ä»·å€¼: {{ $store.getters.totalPriceCountGreaterN(1) }}</h2>
    <hr />
    <h2>{{ sNameInfo }}</h2>
    <h2>{{ sAgeInfo }}</h2>
    <h2>{{ ageInfo }}</h2>
    <h2>{{ heightInfo }}</h2>
    <hr />
  </div>
</template>

<script>
import { mapGetters } from 'vuex'

export default {
  computed: {
    ...mapGetters(['nameInfo', 'ageInfo', 'heightInfo']),
    ...mapGetters({
      sNameInfo: 'nameInfo',
      sAgeInfo: 'ageInfo',
    }),
  },
  setup() {},
}
</script>
```



### composition ä¸­ä½¿ç”¨ ğŸ”¥

åŒæ ·çš„ mapGetters è¿”å›çš„æ˜¯å€¼ä¸ºfunctionçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è§£æ„ï¼Œéœ€éå†å¹¶ä½¿ç”¨è®¡ç®—å±æ€§ï¼Œå°è£…åè§ **Vuexå°è£…â€”æœ€ç»ˆ**

ä½¿ç”¨

```vue
<template>
  <div>
    <h2>æ€»ä»·å€¼: {{ $store.getters.totalPrice }}</h2>
    <h2>æ€»ä»·å€¼: {{ $store.getters.totalPriceCountGreaterN(1) }}</h2>
    <hr />
    <h2>{{ nameInfo }}</h2>
    <h2>{{ ageInfo }}</h2>
    <h2>{{ heightInfo }}</h2>
    <hr />
  </div>
</template>

<script>
// import { useGetters } from '../hooks/useVuex'

// export default {
//   computed: {},
//   setup() {
//     const storeGetters = useGetters(['nameInfo', 'ageInfo', 'heightInfo'])
//     return {
//       ...storeGetters,
//     }
//   },
// }
</script>

<script setup>
import { useGetters } from '../hooks/useVuex'

const { nameInfo, ageInfo, heightInfo } = useGetters([
  'nameInfo',
  'ageInfo',
  'heightInfo',
])
</script>
```







## mutations & commit & mapMutations ğŸ”¥

### æ³¨æ„ï¼šå¿…é¡»æ˜¯åŒæ­¥å‡½æ•°

* **mutation å¿…é¡»æ˜¯åŒæ­¥å‡½æ•°**
* è¿™æ˜¯å› ä¸ºdevtoolå·¥å…·ä¼šè®°å½•mutationçš„æ—¥è®°ï¼Œæ¯ä¸€æ¡mutationè¢«è®°å½•ï¼Œdevtoolséƒ½éœ€è¦æ•æ‰åˆ°å‰ä¸€çŠ¶æ€å’Œåä¸€çŠ¶æ€çš„å¿«ç…§ã€‚ä½†æ˜¯åœ¨mutationä¸­æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå°±æ— æ³•è¿½è¸ªåˆ°æ•°æ®çš„å˜åŒ–ï¼Œæ‰€ä»¥Vuexçš„é‡è¦åŸåˆ™ä¸­è¦æ±‚ mutationå¿…é¡»æ˜¯åŒæ­¥å‡½æ•°



### mutations & commit

/src/store/index.js

```js
import { createStore } from 'vuex'
import { INCREMENT_N } from './mutation-types'

export default createStore({
  state: {
    counter: 100,
    name: 'conanan',
    age: 18,
    height: 188,
    books: [
      { name: 'æ·±å…¥Vuejs', price: 200, count: 3 },
      { name: 'æ·±å…¥Webpack', price: 240, count: 5 },
      { name: 'æ·±å…¥React', price: 130, count: 1 },
      { name: 'æ·±å…¥Node', price: 220, count: 2 },
    ],
    discount: 0.6,
  },
  mutations: {
    increment(state) {
      state.counter++
    },
    decrement(state) {
      state.counter--
    },
    // 10 -> payload
    // {n: 10, name: "why", age: 18} -> payload
    [INCREMENT_N](state, payload) {
      console.log(payload)
      state.counter += payload.n
    },
  },
  actions: {},
  modules: {},
  getters: {
    
  },
})
```

/src/sotre/mutation-types.js

```js
export const INCREMENT_N = "increment_n"
```

commit ä½¿ç”¨

```vue
<template>
  <div>
    <h2>å½“å‰è®¡æ•°: {{ $store.state.counter }}</h2>
    <hr>
      <button @click="$store.commit('increment')">+1</button>
      <button @click="$store.commit('decrement')">-1</button>
      <button @click="addTen">+10</button>
    <hr>
  </div>
</template>

<script>
  import { INCREMENT_N } from '../store/mutation-types'

  export default {
    methods: {
      addTen() {
        // this.$store.commit('incrementN', 10)
        // this.$store.commit('incrementN', {n: 10, name: "why", age: 18})
        // å¦å¤–ä¸€ç§æäº¤é£æ ¼
        this.$store.commit({
          type: INCREMENT_N,
          n: 10, 
          name: "why", 
          age: 18
        })
      }
    }
  }
</script>
```



### options ä¸­ä½¿ç”¨

```vue
<template>
  <div>
    <h2>å½“å‰è®¡æ•°: {{ $store.state.counter }}</h2>
    <hr />
    <button @click="increment">+1</button>
    <button @click="add">+1</button>
    <button @click="decrement">-1</button>
    <button @click="increment_n({ n: 10 })">+10</button>
    <hr />
  </div>
</template>

<script>
import { mapMutations } from 'vuex'

import { INCREMENT_N } from '../store/mutation-types'

export default {
  methods: {
    ...mapMutations(['increment', 'decrement', INCREMENT_N]),
    ...mapMutations({
      add: 'increment',
    }),
  },
}
</script>
```



### composition ä¸­ä½¿ç”¨ ğŸ”¥

```vue
<template>
  <div>
    <h2>å½“å‰è®¡æ•°: {{ $store.state.counter }}</h2>
    <hr />
    <button @click="increment">+1</button>
    <button @click="add">+1</button>
    <button @click="decrement">-1</button>
    <button @click="increment_n({ n: 10 })">+10</button>
    <hr />
  </div>
</template>

<script>
// import { useMutations } from '../hooks/useVuex'
// import { INCREMENT_N } from '../store/mutation-types'

// export default {
//   setup() {
//     console.log('11')
//     const mutations1 = useMutations(['increment', 'decrement', INCREMENT_N])
//     const mutations2 = useMutations({
//       add: 'increment',
//     })
//     return {
//       ...mutations1,
//       ...mutations2,
//     }
//   },
// }
</script>

<script setup>
import { useMutations } from '../hooks/useVuex'
import { INCREMENT_N } from '../store/mutation-types'

// è¿™é‡Œçš„è§£æ„åªèƒ½ç”¨ increment_n è¡¨ç¤ºäº†ï¼Œæš‚æ—¶æ²¡æœ‰å…¶ä»–åŠæ³•
const { increment, decrement, increment_n } = useMutations([
  'increment',
  'decrement',
  INCREMENT_N,
])
const { add } = useMutations({
  add: 'increment',
})
</script>
```





## actions & dispatch & mapActions ğŸ”¥

/src/store/index.js

```js
import { createStore } from 'vuex'
import axios from 'axios'
import { INCREMENT_N } from './mutation-types'

export default createStore({
  state: {
    counter: 100,
    name: 'conanan',
    age: 18,
    height: 188,
    books: [
      { name: 'æ·±å…¥Vuejs', price: 200, count: 3 },
      { name: 'æ·±å…¥Webpack', price: 240, count: 5 },
      { name: 'æ·±å…¥React', price: 130, count: 1 },
      { name: 'æ·±å…¥Node', price: 220, count: 2 },
    ],
    discount: 0.6,
    banners: [],
  },
  mutations: {
    increment(state) {
      state.counter++
    },
    decrement(state) {
      state.counter--
    },
    // 10 -> payload
    // {n: 10, name: "why", age: 18} -> payload
    [INCREMENT_N](state, payload) {
      console.log(payload)
      state.counter += payload.n
    },
    addBannerData(state, payload) {
      state.banners = payload
    },
  },
  actions: {
    // æ”¾å‡½æ•°
    // 1.å‚æ•°é—®é¢˜
    incrementAction(context, payload) {
      console.log(payload)
      setTimeout(() => {
        context.commit('increment')
      }, 1000)
    },
    // 2.contextçš„å…¶ä»–å±æ€§
    decrementAction({
      commit,
      dispatch,
      state,
      rootState,
      getters,
      rootGetters,
    }) {
      commit('decrement')
    },
    getHomeMultidata(context) {
      return new Promise((resolve, reject) => {
        axios
          .get('http://123.207.32.32:8000/home/multidata')
          .then((res) => {
            context.commit('addBannerData', res.data.data.banner.list)
            resolve({ name: 'coderwhy', age: 18 })
          })
          .catch((err) => {
            reject(err)
          })
      })
    },
  },
  modules: {},
  getters: {
    
  },
})

```



### æ³¨æ„ï¼šå¯ä»¥åŒ…å«å¼‚æ­¥æ“ä½œ

* Action**æäº¤çš„æ˜¯mutation**ï¼Œè€Œ**ä¸æ˜¯ç›´æ¥å˜æ›´çŠ¶æ€**
* Actionå¯ä»¥**åŒ…å«ä»»æ„å¼‚æ­¥æ“ä½œ**



### context ğŸ”¥

* contextæ˜¯ä¸€ä¸ª**å’Œstoreå®ä¾‹å‡æœ‰ç›¸åŒæ–¹æ³•å’Œå±æ€§**çš„contextå¯¹è±¡;
* æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»å…¶ä¸­è·å–åˆ° commit æ–¹æ³•æ¥æäº¤ä¸€ä¸ª mutationï¼Œæˆ–è€…é€šè¿‡ context.state å’Œ context.getters æ¥è·å– state å’Œ gettersã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–å‚æ•°ã€‚
* ä½†æ˜¯ä¸ºä»€ä¹ˆå®ƒä¸æ˜¯storeå¯¹è±¡å‘¢?è¿™ä¸ªç­‰åˆ°æˆ‘ä»¬è®²**Modules**æ—¶å†å…·ä½“æ¥è¯´;



### actions è¿”å›å€¼ ğŸ”¥

Action é€šå¸¸æ˜¯å¼‚æ­¥çš„ï¼Œé‚£ä¹ˆå¦‚ä½•çŸ¥é“ action ä»€ä¹ˆæ—¶å€™ç»“æŸå‘¢?

* æˆ‘ä»¬å¯ä»¥é€šè¿‡è®©action**è¿”å›Promise**ï¼Œåœ¨Promiseçš„thenä¸­æ¥å¤„ç†å®Œæˆåçš„æ“ä½œ;



### options ä¸­ä½¿ç”¨

```vue
<template>
  <div>
    <h2>å½“å‰è®¡æ•°: {{ $store.state.counter }}</h2>
    <hr />
    <button @click="incrementAction">+1</button>
    <button @click="decrementAction">-1</button>
    <button @click="add">+1</button>
    <button @click="sub">-1</button>
    <hr />
  </div>
</template>

<script>
import { mapActions } from 'vuex';

export default {
  methods: {
    ...mapActions(["incrementAction", "decrementAction"]),
    ...mapActions({
      add: "incrementAction",
      sub: "decrementAction"
    })
  },
}
</script>
```



### composition ä¸­ä½¿ç”¨ ğŸ”¥

```vue
<template>
  <div>
    <h2>å½“å‰è®¡æ•°: {{ $store.state.counter }}</h2>
    <hr />
    <button @click="incrementAction">+1</button>
    <button @click="decrementAction">-1</button>
    <button @click="add">+1</button>
    <button @click="sub">-1</button>
    <hr />
  </div>
</template>

<script>
// import { mapActions } from 'vuex'
// import { useActions } from '../hooks/useVuex'

// export default {
//   setup() {
//     const actions = mapActions(['incrementAction', 'decrementAction'])
//     const actions2 = mapActions({
//       add: 'incrementAction',
//       sub: 'decrementAction',
//     })
//     console.log('actions', actions)
//     console.log('actions2', actions2)
//     return {
//       ...actions,
//       ...actions2,
//     }
//   },
// }
</script>

<script setup>
import { useActions } from '../hooks/useVuex'

const { incrementAction, decrementAction } = useActions([
  'incrementAction',
  'decrementAction',
])

const { add, sub } = useActions({
  add: 'incrementAction',
  sub: 'decrementAction',
})
</script>
```





## module ğŸ”¥

### ä»€ä¹ˆæ˜¯Module

* ç”±äºä½¿ç”¨å•ä¸€çŠ¶æ€æ ‘ï¼Œåº”ç”¨çš„æ‰€æœ‰çŠ¶æ€ä¼šé›†ä¸­åˆ°ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å¯¹è±¡ï¼Œå½“åº”ç”¨éå¸¸å¤æ‚æ—¶ï¼Œstore å°±æœ‰å¯èƒ½å˜å¾—ç›¸å½“è‡ƒè‚¿;
* ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜ï¼ŒVuex å…è®¸æˆ‘ä»¬å°† store åˆ†å‰²æˆ**æ¨¡å—(module)**; 
* æ¯ä¸ªæ¨¡å—æ‹¥æœ‰è‡ªå·±çš„ stateã€mutationã€actionã€getterã€ç”šè‡³æ˜¯åµŒå¥—å­æ¨¡å—;



### store

/src/store/index.js

```js
import { createStore } from "vuex"
import home from './modules/home'
import user from './modules/user'

const store = createStore({
  state() {
    return {
      rootCounter: 100
    }
  },
  getters: {
    doubleRootCounter(state) {
      return state.rootCounter * 2
    }
  },
  mutations: {
    increment(state) {
      state.rootCounter++
    }
  },
  modules: {
    home,
    user
  }
});

export default store;
```

/src/store/modules/home.js

```js
const homeModule = {
  namespaced: true,
  state() {
    return {
      homeCounter: 100
    }
  },
  getters: {
    doubleHomeCounter(state, getters, rootState, rootGetters) {
      return state.homeCounter * 2
    },
    otherGetter(state) {
      return 100
    }
  },
  mutations: {
    increment(state) {
      state.homeCounter++
    }
  },
  actions: {
    incrementAction({commit, dispatch, state, rootState, getters, rootGetters}) {
      commit("increment")
      commit("increment", null, {root: true})

      // dispatch
      // dispatch("incrementAction", null, {root: true})
    }
  }
}

export default homeModule
```

/src/store/modules/user.js

```js
const userModule = {
  namespaced: true,
  state() {
    return {
      userCounter: 10
    }
  },
  getters: {

  },
  mutations: {

  },
  actions: {

  }
}

export default userModule
```





### state ä½¿ç”¨

```vue
<template>
  <div>
    <h2>{{ $store.state.rootCounter }}</h2>
    <h2>{{ $store.state.home.homeCounter }}</h2>
    <h2>{{ $store.state.user.userCounter }}</h2>
  </div>
</template>

<script>
  export default {
    setup() {
    }
  }
</script>

<style scoped>

</style><template>
  <div>
    <h2>{{ $store.state.rootCounter }}</h2>
    <h2>{{ $store.state.home.homeCounter }}</h2>
    <h2>{{ $store.state.user.userCounter }}</h2>
  </div>
</template>

<script>
  export default {
    setup() {
    }
  }
</script>
```



### moduleçš„å±€éƒ¨çŠ¶æ€

å¯¹äºæ¨¡å—å†…éƒ¨çš„ mutation å’Œ getterï¼Œæ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯**æ¨¡å—çš„å±€éƒ¨çŠ¶æ€å¯¹è±¡**



### moduleçš„å‘½åç©ºé—´ ğŸ”¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å—å†…éƒ¨çš„ action å’Œmutation ä»ç„¶æ˜¯æ³¨å†Œåœ¨**å…¨å±€çš„å‘½åç©ºé—´**ä¸­çš„: 

* è¿™æ ·ä½¿å¾—å¤šä¸ªæ¨¡å—èƒ½å¤Ÿå¯¹åŒä¸€ä¸ª action æˆ– mutation ä½œå‡ºå“åº”;
* **Getter åŒæ ·ä¹Ÿé»˜è®¤æ³¨å†Œåœ¨å…¨å±€å‘½åç©ºé—´**;

å¦‚æœæˆ‘ä»¬å¸Œæœ›æ¨¡å—å…·æœ‰æ›´é«˜çš„å°è£…åº¦å’Œå¤ç”¨æ€§ï¼Œå¯ä»¥æ·»åŠ  **namespaced: true** çš„æ–¹å¼ä½¿å…¶æˆä¸ºå¸¦å‘½åç©ºé—´çš„æ¨¡å—: 

* å½“æ¨¡å—è¢«æ³¨å†Œåï¼Œå®ƒçš„æ‰€æœ‰ getterã€action åŠ mutation éƒ½ä¼šè‡ªåŠ¨æ ¹æ®æ¨¡å—æ³¨å†Œçš„è·¯å¾„è°ƒæ•´å‘½å

```vue
<template>
  <div>
    <h2>root:{{ $store.state.rootCounter }}</h2>
    <h2>home:{{ $store.state.home.homeCounter }}</h2>
    <h2>user:{{ $store.state.user.userCounter }}</h2>

    <hr>
    <h2>{{ $store.getters["home/doubleHomeCounter"] }}</h2>

    <button @click="homeIncrement">home+1</button>
    <button @click="homeIncrementAction">home+1</button>
  </div>
</template>

<script>
  export default {
    methods: {
      homeIncrement() {
        this.$store.commit("home/increment")
      },
      homeIncrementAction() {
        this.$store.dispatch("home/incrementAction")
      }
    }
  }
</script>
```

* è®¿é—® state æ—¶ï¼š`$store.state.user.xxx`
* è®¿é—®å…¶ä»–3ä¸ªï¼š`$store.commit("user/changeName")`

![image-20220209173948898](./images/image-20220209173948898.png)



### moduleä¿®æ”¹æˆ–æ´¾å‘æ ¹ç»„ä»¶

å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨actionä¸­ä¿®æ”¹rootä¸­çš„stateï¼Œé‚£ä¹ˆæœ‰å¦‚ä¸‹çš„æ–¹å¼

```js
actions: {
    incrementAction({commit, dispatch, state, rootState, getters, rootGetters}) {
      commit("increment")
      // null æ˜¯ payload
      commit("increment", null, {root: true})

      // dispatch åŒæ ·
      // dispatch("incrementAction", null, {root: true})
    }
  }
```





### moduleçš„è¾…åŠ©å‡½æ•° ğŸ”¥

å¦‚æœè¾…åŠ©å‡½æ•°æœ‰ä¸‰ç§ä½¿ç”¨æ–¹æ³•:

* æ–¹å¼ä¸€:é€šè¿‡å®Œæ•´çš„æ¨¡å—ç©ºé—´åç§°æ¥æŸ¥æ‰¾;
* æ–¹å¼äºŒ:ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥æ¨¡å—ç©ºé—´åç§°ï¼Œåé¢å†™ä¸Šè¦ä½¿ç”¨çš„å±æ€§; 
* æ–¹å¼ä¸‰:é€šè¿‡ createNamespacedHelpers ç”Ÿæˆä¸€ä¸ªæ¨¡å—çš„è¾…åŠ©å‡½æ•°;

```vue
<template>
  <div>
    <hr>
    <h2>{{ homeCounter }}</h2>
    <h2>{{ doubleHomeCounter }}</h2>
    <!-- <h2>{{ doubleRootCounter }}</h2> -->
    <button @click="increment">home+1</button>
    <button @click="incrementAction">home+1</button>
    <hr>
  </div>
</template>

<script>
  import { createNamespacedHelpers, mapState, mapGetters, mapMutations, mapActions } from "vuex";

  import { useState, useGetters } from '../hooks/index'

  // const { mapState, mapGetters, mapMutations, mapActions } = createNamespacedHelpers("home")

  export default {
    computed: {
      // 1.å†™æ³•ä¸€:
      // ...mapState({
      //   homeCounter: state => state.home.homeCounter
      // }),
      // ...mapGetters({
      //   doubleHomeCounter: "home/doubleHomeCounter"
      // })

      // 2.å†™æ³•äºŒ:
      // ...mapState("home", ["homeCounter"]),
      // ...mapGetters("home", ["doubleHomeCounter"])

      // 3.å†™æ³•ä¸‰:
      // ...mapState(["homeCounter"]),
      // ...mapGetters(["doubleHomeCounter"])
    },
    methods: {
      // 1.å†™æ³•ä¸€:
      // ...mapMutations({
      //   increment: "home/increment"
      // }),
      // ...mapActions({
      //   incrementAction: "home/incrementAction"
      // }),

      // 2.å†™æ³•äºŒ
      // ...mapMutations("home", ["increment"]),
      // ...mapActions("home", ["incrementAction"]),
      
      // 3.å†™æ³•ä¸‰:
      // ...mapMutations(["increment"]),
      // ...mapActions(["incrementAction"]),
    },

    setup() {
      // {homeCounter: function}
      // const state = useState(["rootCounter"])
      // const rootGetters = useGetters(["doubleRootCounter"])
      // const getters = useGetters("home", ["doubleHomeCounter"])

      // const mutations = mapMutations(["increment"])
      // const actions = mapActions(["incrementAction"])

      return {
        // ...state,
        // ...getters,
        // ...rootGetters
        // ...mutations,
        // ...actions
      }
    }
  }
</script>
```





## Vuex å°è£…

### mapState & mapGetters å°è£… â‘ 

å°è£…ä¸å¤Ÿå½»åº•

/src/hooks/index.js

```js
import { useGetters } from './useGetters';
import { useState } from './useState';

export {
  useGetters,
  useState
}
```

/src/hooks/useState.js

```js
import { mapState } from 'vuex'
import { useMapper } from './useMapper'

export function useState(mapper) {
  return useMapper(mapper, mapState)
}
```

/src/hooks/useGetters.js

```js
import { mapGetters } from 'vuex'
import { useMapper } from './useMapper'

export function useGetters(mapper) {
  return useMapper(mapper, mapGetters)
}
```

/src/hooks/useMapper.js

```js
import { computed } from 'vue'
import { useStore } from 'vuex'

export function useMapper(mapper, mapFn) {
  // æ‹¿åˆ°storeç‹¬äº«
  const store = useStore()

  // è·å–åˆ°å¯¹åº”çš„å¯¹è±¡çš„functions: {name: function, age: function}
  const storeStateFns = mapFn(mapper)

  // å¯¹æ•°æ®è¿›è¡Œè½¬æ¢
  const storeState = {}
  Object.keys(storeStateFns).forEach(fnKey => {
    const fn = storeStateFns[fnKey].bind({$store: store})
    storeState[fnKey] = computed(fn)
  })

  return storeState
}
```



### æ²¡æœ‰æ¨¡å—å°è£… ğŸ”¥

/src/hooks/useVuex.js

```js
import { computed } from 'vue'
import { useStore, mapState, mapGetters, mapMutations, mapActions } from 'vuex'

export function useState(mapper) {
  return useMapper(mapper, mapState, 'computed')
}

export function useGetters(mapper) {
  return useMapper(mapper, mapGetters, 'computed')
}

export function useMutations(mapper) {
  return useMapper(mapper, mapMutations, 'function')
}

export function useActions(mapper) {
  return useMapper(mapper, mapActions, 'function')
}

export function useMapper(mapper, mapFn, type) {
  // æ‹¿åˆ°storeç‹¬äº«
  const store = useStore()

  // è·å–åˆ°å¯¹åº”çš„å¯¹è±¡çš„functions: {name: function, age: function}
  const storeFns = mapFn(mapper)

  // å¯¹æ•°æ®è¿›è¡Œè½¬æ¢
  const storeInfo = {}
  Object.keys(storeFns).forEach((fnKey) => {
    const fn = storeFns[fnKey].bind({ $store: store })
    storeInfo[fnKey] = type === 'computed' ? computed(fn) : fn
  })

  return storeInfo
}
```



### æœ€ç»ˆ ğŸ”¥

/src/hooks/useVuex.jsï¼Œä½†æ˜¯æ²¡æœ‰ä¼ é€’moduleæ—¶ï¼Œè¿™é‡Œä¹Ÿæ²¡æœ‰ä»indexä¸­æ‰¾å•Šï¼Ÿ

```js
import { computed } from 'vue'
import {
  useStore,
  mapState,
  mapGetters,
  mapMutations,
  mapActions,
  createNamespacedHelpers,
} from 'vuex'

export function useState(moduleName, mapper) {
  let mapperFn = mapState
  if (typeof moduleName === 'string' && moduleName.length > 0) {
    mapperFn = createNamespacedHelpers(moduleName).mapState
  }
  return useMapper(mapper, mapperFn, 'computed')
}

export function useGetters(moduleName, mapper) {
  let mapperFn = mapGetters
  if (typeof moduleName === 'string' && moduleName.length > 0) {
    mapperFn = createNamespacedHelpers(moduleName).mapGetters
  }
  return useMapper(mapper, mapperFn, 'computed')
}

export function useMutations(moduleName, mapper) {
  let mapperFn = mapMutations
  if (typeof moduleName === 'string' && moduleName.length > 0) {
    mapperFn = createNamespacedHelpers(moduleName).mapMutations
  }
  return useMapper(mapper, mapperFn, 'function')
}

export function useActions(moduleName, mapper) {
  let mapperFn = mapActions
  if (typeof moduleName === 'string' && moduleName.length > 0) {
    mapperFn = createNamespacedHelpers(moduleName).mapActions
  }
  return useMapper(mapper, mapperFn, 'function')
}

export function useMapper(mapper, mapFn, type) {
  // æ‹¿åˆ°storeç‹¬äº«
  const store = useStore()

  // è·å–åˆ°å¯¹åº”çš„å¯¹è±¡çš„functions: {name: function, age: function}
  const storeFns = mapFn(mapper)

  // å¯¹æ•°æ®è¿›è¡Œè½¬æ¢
  const storeInfo = {}
  Object.keys(storeFns).forEach((fnKey) => {
    const fn = storeFns[fnKey].bind({ $store: store })
    storeInfo[fnKey] = type === 'computed' ? computed(fn) : fn
  })

  return storeInfo
}
```



## æ³¨æ„ ğŸ”¥

ä¸Šé¢ç¤ºä¾‹ä¸­ setup() å’Œ setup script ä¸èƒ½å…±å­˜ï¼Œå¦åˆ™æ‰§è¡Œçš„æ˜¯ setup script ä»£ç 
